

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ooni.nettest &mdash; OONI: Open Observatory of Network Interference 1.3.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="OONI: Open Observatory of Network Interference 1.3.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> OONI: Open Observatory of Network Interference</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#writing-a-tcp-port-scanner">Writing a TCP port scanner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#creating-test">Creating test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#inputs">Inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#writing-tests">Writing Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#runninng-tests">Runninng Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#reports">Reports</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../writing_tests.html">Writing OONI tests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../writing_tests.html#test-cases">Test Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../writing_tests.html#inputs">Inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../writing_tests.html#setup-and-command-line-passing">Setup and command line passing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../writing_tests.html#test-methods">Test Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../writing_tests.html#test-templates">Test Templates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reports.html">Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reports.html#report-format-version-changelog">Report format version changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reports.html#version-0-1">version 0.1</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../nettests/modules.html">Implemented NetTests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../nettests/ooni.nettests.blocking.html">ooni.nettests blocking Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nettests/ooni.nettests.examples.html">ooni.nettests examples Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nettests/ooni.nettests.experimental.html">ooni.nettests experimental Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nettests/ooni.nettests.manipulation.html">ooni.nettests manipulation Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nettests/ooni.nettests.scanning.html">ooni.nettests scanning Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nettests/ooni.nettests.third_party.html">ooni.nettests third_party Package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/ooni.html">Measurement Developer API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.html#module-ooni.nettest"><code class="docutils literal"><span class="pre">nettest</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.html#module-ooni.settings"><code class="docutils literal"><span class="pre">settings</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.html#module-ooni.oonicli"><code class="docutils literal"><span class="pre">oonicli</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.html#module-ooni.reporter"><code class="docutils literal"><span class="pre">reporter</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.html#subpackages">Subpackages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/ooni.templates.html">Test Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.templates.html#module-ooni.templates.httpt"><code class="docutils literal"><span class="pre">ooni.templates.httpt</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.templates.html#module-ooni.templates.scapyt"><code class="docutils literal"><span class="pre">ooni.templates.scapyt</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.templates.html#module-ooni.templates.dnst"><code class="docutils literal"><span class="pre">ooni.templates.dnst</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/ooni.templates.html#module-ooni.templates.tcpt"><code class="docutils literal"><span class="pre">ooni.templates.tcpt</span></code> Module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#ooniprobe">ooniprobe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#oonib">oonib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#an-ooniprobe-run">An ooniprobe run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#ooniprobe-api">ooniprobe API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#towards-a-rpc-like-interface">Towards a RPC like interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#draft-api-specification">Draft API specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#implementation-status">Implementation status</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">OONI: Open Observatory of Network Interference</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>ooni.nettest</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for ooni.nettest</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.trial.runner</span> <span class="kn">import</span> <span class="n">filenameToModule</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">usage</span><span class="p">,</span> <span class="n">reflect</span>

<span class="kn">from</span> <span class="nn">ooni</span> <span class="kn">import</span> <span class="n">otime</span>
<span class="kn">from</span> <span class="nn">ooni.tasks</span> <span class="kn">import</span> <span class="n">Measurement</span>
<span class="kn">from</span> <span class="nn">ooni.utils</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">sanitize_options</span><span class="p">,</span> <span class="n">randomStr</span>
<span class="kn">from</span> <span class="nn">ooni.utils.net</span> <span class="kn">import</span> <span class="n">hasRawSocketPermission</span>
<span class="kn">from</span> <span class="nn">ooni.settings</span> <span class="kn">import</span> <span class="n">config</span>

<span class="kn">from</span> <span class="nn">ooni</span> <span class="kn">import</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">e</span>

<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmembers</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>


<div class="viewcode-block" id="NoTestCasesFound"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NoTestCasesFound">[docs]</a><span class="k">class</span> <span class="nc">NoTestCasesFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="getTestClassFromFile"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.getTestClassFromFile">[docs]</a><span class="k">def</span> <span class="nf">getTestClassFromFile</span><span class="p">(</span><span class="n">net_test_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will return the first class that is an instance of NetTestCase.</span>

<span class="sd">    XXX this means that if inside of a test there are more than 1 test case</span>
<span class="sd">        then we will only run the first one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">filenameToModule</span><span class="p">(</span><span class="n">net_test_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">__</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">NetTestCase</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">item</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">pass</span>

</div>
<div class="viewcode-block" id="getOption"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.getOption">[docs]</a><span class="k">def</span> <span class="nf">getOption</span><span class="p">(</span><span class="n">opt_parameter</span><span class="p">,</span> <span class="n">required_options</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;text&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">        usage_options: a list as should be the optParameters of an UsageOptions</span>
<span class="sd">            class.</span>

<span class="sd">        required_options: a list containing the strings of the options that are</span>
<span class="sd">            required.</span>

<span class="sd">        type: a string containing the type of the option.</span>

<span class="sd">    Returns:</span>
<span class="sd">        a dict containing</span>
<span class="sd">            {</span>
<span class="sd">                &#39;description&#39;: the description of the option,</span>
<span class="sd">                &#39;default&#39;: the default value of the option,</span>
<span class="sd">                &#39;required&#39;: True|False if the option is required or not,</span>
<span class="sd">                &#39;type&#39;: the type of the option (&#39;text&#39; or &#39;file&#39;)</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">option_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">opt_parameter</span>
    <span class="k">if</span> <span class="n">option_name</span> <span class="ow">in</span> <span class="n">required_options</span><span class="p">:</span>
        <span class="n">required</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">required</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span> <span class="s">&#39;required&#39;</span><span class="p">:</span> <span class="n">required</span><span class="p">,</span>
            <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span>
            <span class="p">}</span>

</div>
<div class="viewcode-block" id="getArguments"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.getArguments">[docs]</a><span class="k">def</span> <span class="nf">getArguments</span><span class="p">(</span><span class="n">test_class</span><span class="p">):</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">test_class</span><span class="o">.</span><span class="n">inputFile</span><span class="p">:</span>
        <span class="n">option_name</span> <span class="o">=</span> <span class="n">test_class</span><span class="o">.</span><span class="n">inputFile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">arguments</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">getOption</span><span class="p">(</span>
            <span class="n">test_class</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span>
            <span class="n">test_class</span><span class="o">.</span><span class="n">requiredOptions</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s">&#39;file&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">test_class</span><span class="o">.</span><span class="n">usageOptions</span><span class="o">.</span><span class="n">optParameters</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arguments</span>

    <span class="k">for</span> <span class="n">opt_parameter</span> <span class="ow">in</span> <span class="n">test_class</span><span class="o">.</span><span class="n">usageOptions</span><span class="o">.</span><span class="n">optParameters</span><span class="p">:</span>
        <span class="n">option_name</span> <span class="o">=</span> <span class="n">opt_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">opt_type</span> <span class="o">=</span> <span class="s">&quot;text&quot;</span>
        <span class="k">if</span> <span class="n">opt_parameter</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">):</span>
            <span class="n">opt_type</span> <span class="o">=</span> <span class="s">&quot;file&quot;</span>
        <span class="n">arguments</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">getOption</span><span class="p">(</span>
            <span class="n">opt_parameter</span><span class="p">,</span>
            <span class="n">test_class</span><span class="o">.</span><span class="n">requiredOptions</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">opt_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">arguments</span>

</div>
<div class="viewcode-block" id="test_class_name_to_name"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.test_class_name_to_name">[docs]</a><span class="k">def</span> <span class="nf">test_class_name_to_name</span><span class="p">(</span><span class="n">test_class_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">test_class_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getNetTestInformation"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.getNetTestInformation">[docs]</a><span class="k">def</span> <span class="nf">getNetTestInformation</span><span class="p">(</span><span class="n">net_test_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dict containing:</span>

<span class="sd">    {</span>
<span class="sd">        &#39;id&#39;: the test filename excluding the .py extension,</span>
<span class="sd">        &#39;name&#39;: the full name of the test,</span>
<span class="sd">        &#39;description&#39;: the description of the test,</span>
<span class="sd">        &#39;version&#39;: version number of this test,</span>
<span class="sd">        &#39;arguments&#39;: a dict containing as keys the supported arguments and as</span>
<span class="sd">            values the argument description.</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_class</span> <span class="o">=</span> <span class="n">getTestClassFromFile</span><span class="p">(</span><span class="n">net_test_file</span><span class="p">)</span>

    <span class="n">test_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">net_test_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.py&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">information</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">test_id</span><span class="p">,</span>
                   <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">test_class</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                   <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="n">test_class</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                   <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="n">test_class</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                   <span class="s">&#39;arguments&#39;</span><span class="p">:</span> <span class="n">getArguments</span><span class="p">(</span><span class="n">test_class</span><span class="p">),</span>
                   <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">net_test_file</span><span class="p">,</span>
                   <span class="p">}</span>
    <span class="k">return</span> <span class="n">information</span>

</div>
<div class="viewcode-block" id="NetTestLoader"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestLoader">[docs]</a><span class="k">class</span> <span class="nc">NetTestLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">method_prefix</span> <span class="o">=</span> <span class="s">&#39;test&#39;</span>
    <span class="n">collector</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">requiresTor</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">reportID</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">test_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">test_string</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onionInputRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="s">&quot;(httpo://[a-z0-9]{16}\.onion)/input/([a-z0-9]{64})$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">test_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadNetTestFile</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">test_string</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadNetTestString</span><span class="p">(</span><span class="n">test_string</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requiredTestHelpers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">required_test_helpers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">required_test_helpers</span>

        <span class="k">for</span> <span class="n">test_class</span><span class="p">,</span> <span class="n">test_methods</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">test_class</span><span class="o">.</span><span class="n">requiredTestHelpers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">required_test_helpers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s">&#39;option&#39;</span><span class="p">:</span> <span class="n">option</span><span class="p">,</span>
                    <span class="s">&#39;test_class&#39;</span><span class="p">:</span> <span class="n">test_class</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">required_test_helpers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">input_files</span>

        <span class="k">for</span> <span class="n">test_class</span><span class="p">,</span> <span class="n">test_methods</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_class</span><span class="o">.</span><span class="n">inputFile</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">test_class</span><span class="o">.</span><span class="n">inputFile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">test_class</span><span class="o">.</span><span class="n">localOptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">input_file</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                    <span class="s">&#39;test_class&#39;</span><span class="p">:</span> <span class="n">test_class</span>
                <span class="p">}</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onionInputRegex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">input_file</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
                    <span class="n">input_file</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">input_file</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_file</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">InvalidInputFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">input_file</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="n">input_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">testDetails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ooni</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">software_version</span>

        <span class="n">input_file_hashes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">input_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFiles</span><span class="p">:</span>
            <span class="n">input_file_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_file</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">])</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">sanitize_options</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="n">test_details</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">otime</span><span class="o">.</span><span class="n">epochToUTC</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
            <span class="s">&#39;probe_asn&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">probe_ip</span><span class="o">.</span><span class="n">geodata</span><span class="p">[</span><span class="s">&#39;asn&#39;</span><span class="p">],</span>
            <span class="s">&#39;probe_cc&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">probe_ip</span><span class="o">.</span><span class="n">geodata</span><span class="p">[</span><span class="s">&#39;countrycode&#39;</span><span class="p">],</span>
            <span class="s">&#39;probe_ip&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">probe_ip</span><span class="o">.</span><span class="n">geodata</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span>
            <span class="s">&#39;probe_city&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">probe_ip</span><span class="o">.</span><span class="n">geodata</span><span class="p">[</span><span class="s">&#39;city&#39;</span><span class="p">],</span>
            <span class="s">&#39;test_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">testName</span><span class="p">,</span>
            <span class="s">&#39;test_version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">testVersion</span><span class="p">,</span>
            <span class="s">&#39;software_name&#39;</span><span class="p">:</span> <span class="s">&#39;ooniprobe&#39;</span><span class="p">,</span>
            <span class="s">&#39;software_version&#39;</span><span class="p">:</span> <span class="n">software_version</span><span class="p">,</span>
            <span class="s">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
            <span class="s">&#39;input_hashes&#39;</span><span class="p">:</span> <span class="n">input_file_hashes</span><span class="p">,</span>
            <span class="s">&#39;report_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportID</span><span class="p">,</span>
            <span class="s">&#39;test_helpers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">testHelpers</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">test_details</span>

    <span class="k">def</span> <span class="nf">_parseNetTestOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to assemble the options into a single UsageOptions object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">usage_options</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">usageOptions</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">usage_options</span><span class="p">,</span> <span class="s">&#39;optParameters&#39;</span><span class="p">):</span>
            <span class="n">usage_options</span><span class="o">.</span><span class="n">optParameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">usage_options</span><span class="o">.</span><span class="n">optParameters</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">parameter</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">inputFile</span><span class="p">:</span>
            <span class="n">usage_options</span><span class="o">.</span><span class="n">optParameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">baseParameters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="n">baseParameters</span><span class="p">:</span>
                <span class="n">usage_options</span><span class="o">.</span><span class="n">optParameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">baseFlags</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">usage_options</span><span class="p">,</span> <span class="s">&#39;optFlags&#39;</span><span class="p">):</span>
                <span class="n">usage_options</span><span class="o">.</span><span class="n">optFlags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="n">baseFlags</span><span class="p">:</span>
                <span class="n">usage_options</span><span class="o">.</span><span class="n">optFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">usage_options</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">usageOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">usage_options</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">test_class</span><span class="p">,</span> <span class="n">test_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">usage_options</span><span class="p">:</span>
                <span class="n">usage_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseNetTestOptions</span><span class="p">(</span><span class="n">test_class</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">usage_options</span> <span class="o">!=</span> <span class="n">test_class</span><span class="o">.</span><span class="n">usageOptions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">IncoherentOptions</span><span class="p">(</span><span class="n">usage_options</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                              <span class="n">test_class</span><span class="o">.</span><span class="n">usageOptions</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">usage_options</span>

<div class="viewcode-block" id="NetTestLoader.loadNetTestString"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestLoader.loadNetTestString">[docs]</a>    <span class="k">def</span> <span class="nf">loadNetTestString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_test_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load NetTest from a string.</span>
<span class="sd">        WARNING input to this function *MUST* be sanitized and *NEVER* take</span>
<span class="sd">        untrusted input.</span>
<span class="sd">        Failure to do so will result in code exec.</span>

<span class="sd">        net_test_string:</span>

<span class="sd">            a string that contains the net test to be run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">net_test_file_object</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">net_test_string</span><span class="p">)</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">exec</span> <span class="n">net_test_file_object</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ns</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">test_cases</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_test_methods</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_cases</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">NoTestCasesFound</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setupTestCases</span><span class="p">(</span><span class="n">test_cases</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetTestLoader.loadNetTestFile"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestLoader.loadNetTestFile">[docs]</a>    <span class="k">def</span> <span class="nf">loadNetTestFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_test_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load NetTest from a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">filenameToModule</span><span class="p">(</span><span class="n">net_test_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">__</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
            <span class="n">test_cases</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_test_methods</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_cases</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">NoTestCasesFound</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setupTestCases</span><span class="p">(</span><span class="n">test_cases</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetTestLoader.setupTestCases"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestLoader.setupTestCases">[docs]</a>    <span class="k">def</span> <span class="nf">setupTestCases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_cases</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates all the necessary test_cases (a list of tuples containing the</span>
<span class="sd">        NetTestCase (test_class, test_method))</span>

<span class="sd">        example:</span>
<span class="sd">            [(test_classA, test_method1),</span>
<span class="sd">            (test_classA, test_method2),</span>
<span class="sd">            (test_classA, test_method3),</span>
<span class="sd">            (test_classA, test_method4),</span>
<span class="sd">            (test_classA, test_method5),</span>

<span class="sd">            (test_classB, test_method1),</span>
<span class="sd">            (test_classB, test_method2)]</span>

<span class="sd">        Note: the inputs must be valid for test_classA and test_classB.</span>

<span class="sd">        net_test_file:</span>
<span class="sd">            is either a file path or a file like object that will be used to</span>
<span class="sd">            generate the test_cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_class</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">test_cases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testVersion</span> <span class="o">=</span> <span class="n">test_class</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testName</span> <span class="o">=</span> <span class="n">test_class_name_to_name</span><span class="p">(</span><span class="n">test_class</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span> <span class="o">=</span> <span class="n">test_cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testClasses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testHelpers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">reports</span><span class="o">.</span><span class="n">unique_id</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportID</span> <span class="o">=</span> <span class="n">randomStr</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">test_class</span><span class="p">,</span> <span class="n">test_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testClasses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">test_class</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetTestLoader.checkOptions"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestLoader.checkOptions">[docs]</a>    <span class="k">def</span> <span class="nf">checkOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call processTest and processOptions methods of each NetTestCase</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testClasses</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usageOptions</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">parseOptions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">usage</span><span class="o">.</span><span class="n">UsageError</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">OONIUsageError</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tb</span>

            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">klass</span><span class="o">.</span><span class="n">localOptions</span> <span class="o">=</span> <span class="n">options</span>

            <span class="n">test_instance</span> <span class="o">=</span> <span class="n">klass</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">test_instance</span><span class="o">.</span><span class="n">requiresRoot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hasRawSocketPermission</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">InsufficientPrivileges</span>
            <span class="k">if</span> <span class="n">test_instance</span><span class="o">.</span><span class="n">requiresTor</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">requiresTor</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">test_instance</span><span class="o">.</span><span class="n">requirements</span><span class="p">()</span>
            <span class="n">test_instance</span><span class="o">.</span><span class="n">_checkRequiredOptions</span><span class="p">()</span>
            <span class="n">test_instance</span><span class="o">.</span><span class="n">_checkValidOptions</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_get_test_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look for test_ methods in subclasses of NetTestCase</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">NetTestCase</span><span class="p">)</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="n">reflect</span><span class="o">.</span><span class="n">prefixedMethodNames</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_prefix</span><span class="p">)</span>
            <span class="n">test_methods</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="n">test_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method_prefix</span> <span class="o">+</span> <span class="n">method</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">test_methods</span><span class="p">:</span>
                <span class="n">test_cases</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">test_methods</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">test_cases</span>

</div>
<div class="viewcode-block" id="NetTestState"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestState">[docs]</a><span class="k">class</span> <span class="nc">NetTestState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allTasksDone</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This keeps track of the state of a running NetTests case.</span>

<span class="sd">        Args:</span>
<span class="sd">            allTasksDone is a deferred that will get fired once all the NetTest</span>
<span class="sd">            cases have reached a final done state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doneTasks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">completedScheduling</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allTasksDone</span> <span class="o">=</span> <span class="n">allTasksDone</span>

<div class="viewcode-block" id="NetTestState.taskCreated"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestState.taskCreated">[docs]</a>    <span class="k">def</span> <span class="nf">taskCreated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="NetTestState.checkAllTasksDone"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestState.checkAllTasksDone">[docs]</a>    <span class="k">def</span> <span class="nf">checkAllTasksDone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Checking all tasks for completion </span><span class="si">%s</span><span class="s"> == </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doneTasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">completedScheduling</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">doneTasks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allTasksDone</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doneTasks</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetTestState.taskDone"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestState.taskDone">[docs]</a>    <span class="k">def</span> <span class="nf">taskDone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called every time a task has finished running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doneTasks</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkAllTasksDone</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetTestState.allTasksScheduled"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestState.allTasksScheduled">[docs]</a>    <span class="k">def</span> <span class="nf">allTasksScheduled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This should be called once all the tasks that need to run have been</span>
<span class="sd">        scheduled.</span>

<span class="sd">        XXX this is ghetto.</span>
<span class="sd">        The reason for which we are calling allTasksDone inside of the</span>
<span class="sd">        allTasksScheduled method is called after all tasks are done, then we</span>
<span class="sd">        will run into a race condition. The race is that we don&#39;t end up</span>
<span class="sd">        checking that all the tasks are complete because no task is to be</span>
<span class="sd">        scheduled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completedScheduling</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkAllTasksDone</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="NetTest"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTest">[docs]</a><span class="k">class</span> <span class="nc">NetTest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">director</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_test_loader</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        net_test_loader:</span>
<span class="sd">             an instance of :class:ooni.nettest.NetTestLoader containing</span>
<span class="sd">             the test to be run.</span>

<span class="sd">        report:</span>
<span class="sd">            an instance of :class:ooni.reporter.Reporter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span> <span class="o">=</span> <span class="n">net_test_loader</span><span class="o">.</span><span class="n">testCases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testClasses</span> <span class="o">=</span> <span class="n">net_test_loader</span><span class="o">.</span><span class="n">testClasses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testDetails</span> <span class="o">=</span> <span class="n">net_test_loader</span><span class="o">.</span><span class="n">testDetails</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># This will fire when all the measurements have been completed and</span>
        <span class="c"># all the reports are done. Done means that they have either completed</span>
        <span class="c"># successfully or all the possible retries have been reached.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doneNetTest</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">NetTestState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tc</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tc</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">)</span>

<div class="viewcode-block" id="NetTest.doneNetTest"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTest.doneNetTest">[docs]</a>    <span class="k">def</span> <span class="nf">doneNetTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Summary for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">testDetails</span><span class="p">[</span><span class="s">&#39;test_name&#39;</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&quot;------------&quot;</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testDetails</span><span class="p">[</span><span class="s">&#39;test_name&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">test_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testClasses</span><span class="p">:</span>
                <span class="n">test_instance</span> <span class="o">=</span> <span class="n">test_class</span><span class="p">()</span>
                <span class="n">test_instance</span><span class="o">.</span><span class="n">displaySummary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testDetails</span><span class="p">[</span><span class="s">&quot;report_id&quot;</span><span class="p">]:</span>
            <span class="k">print</span> <span class="s">&quot;Report ID: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">testDetails</span><span class="p">[</span><span class="s">&quot;report_id&quot;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="NetTest.doneReport"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTest.doneReport">[docs]</a>    <span class="k">def</span> <span class="nf">doneReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will get called every time a report is done and therefore a</span>
<span class="sd">        measurement is done.</span>

<span class="sd">        The state for the NetTest is informed of the fact that another task has</span>
<span class="sd">        reached the done state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">taskDone</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">report_results</span>
</div>
<div class="viewcode-block" id="NetTest.makeMeasurement"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTest.makeMeasurement">[docs]</a>    <span class="k">def</span> <span class="nf">makeMeasurement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_instance</span><span class="p">,</span> <span class="n">test_method</span><span class="p">,</span> <span class="n">test_input</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new instance of :class:ooni.tasks.Measurement and add&#39;s it&#39;s</span>
<span class="sd">        callbacks and errbacks.</span>

<span class="sd">        Args:</span>
<span class="sd">            test_class:</span>
<span class="sd">                a subclass of :class:ooni.nettest.NetTestCase</span>

<span class="sd">            test_method:</span>
<span class="sd">                a string that represents the method to be called on test_class</span>

<span class="sd">            test_input:</span>
<span class="sd">                optional argument that represents the input to be passed to the</span>
<span class="sd">                NetTestCase</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">measurement</span> <span class="o">=</span> <span class="n">Measurement</span><span class="p">(</span><span class="n">test_instance</span><span class="p">,</span> <span class="n">test_method</span><span class="p">,</span> <span class="n">test_input</span><span class="p">)</span>
        <span class="n">measurement</span><span class="o">.</span><span class="n">netTest</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">director</span><span class="p">:</span>
            <span class="n">measurement</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">director</span><span class="o">.</span><span class="n">measurementSucceeded</span><span class="p">,</span>
                                         <span class="n">measurement</span><span class="p">)</span>
            <span class="n">measurement</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">director</span><span class="o">.</span><span class="n">measurementFailed</span><span class="p">,</span>
                                        <span class="n">measurement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">measurement</span>
</div>
    <span class="nd">@defer.inlineCallbacks</span>
<div class="viewcode-block" id="NetTest.initializeInputProcessor"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTest.initializeInputProcessor">[docs]</a>    <span class="k">def</span> <span class="nf">initializeInputProcessor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">test_class</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="n">test_class</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">defer</span><span class="o">.</span><span class="n">maybeDeferred</span><span class="p">(</span>
                <span class="n">test_class</span><span class="p">()</span><span class="o">.</span><span class="n">getInputProcessor</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_class</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="NetTest.generateMeasurements"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTest.generateMeasurements">[docs]</a>    <span class="k">def</span> <span class="nf">generateMeasurements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a generator that yields measurements and registers the</span>
<span class="sd">        callbacks for when a measurement is successful or has failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">test_class</span><span class="p">,</span> <span class="n">test_methods</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testCases</span><span class="p">:</span>
            <span class="c"># load the input processor as late as possible</span>
            <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">test_class</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="n">measurements</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">test_instance</span> <span class="o">=</span> <span class="n">test_class</span><span class="p">()</span>
                <span class="n">test_instance</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span>
                <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">test_methods</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Running </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_class</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
                    <span class="n">measurement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeMeasurement</span><span class="p">(</span>
                        <span class="n">test_instance</span><span class="p">,</span>
                        <span class="n">method</span><span class="p">,</span>
                        <span class="nb">input</span><span class="p">)</span>
                    <span class="n">measurements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">done</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">taskCreated</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="n">measurement</span>

                <span class="c"># When the measurement.done callbacks have all fired</span>
                <span class="c"># call the postProcessor before writing the report</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
                    <span class="n">post</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">DeferredList</span><span class="p">(</span><span class="n">measurements</span><span class="p">)</span>

                    <span class="nd">@post.addBoth</span>
                    <span class="k">def</span> <span class="nf">set_runtime</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                        <span class="n">runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_instance</span><span class="o">.</span><span class="n">_start_time</span>
                        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                            <span class="n">m</span><span class="o">.</span><span class="n">testInstance</span><span class="o">.</span><span class="n">report</span><span class="p">[</span><span class="s">&#39;test_runtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runtime</span>
                        <span class="n">test_instance</span><span class="o">.</span><span class="n">report</span><span class="p">[</span><span class="s">&#39;test_runtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runtime</span>
                        <span class="k">return</span> <span class="n">results</span>

                    <span class="c"># Call the postProcessor, which must return a single report</span>
                    <span class="c"># or a deferred</span>
                    <span class="n">post</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">test_instance</span><span class="o">.</span><span class="n">postProcessor</span><span class="p">)</span>

                    <span class="k">def</span> <span class="nf">noPostProcessor</span><span class="p">(</span><span class="n">failure</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
                        <span class="n">failure</span><span class="o">.</span><span class="n">trap</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">NoPostProcessor</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">report</span>
                    <span class="n">post</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">noPostProcessor</span><span class="p">,</span> <span class="n">test_instance</span><span class="o">.</span><span class="n">report</span><span class="p">)</span>
                    <span class="n">post</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">director</span><span class="p">:</span>
                    <span class="c"># ghetto hax to keep NetTestState counts are accurate</span>
                    <span class="p">[</span><span class="n">post</span><span class="o">.</span><span class="n">addBoth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doneReport</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">measurements</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">allTasksScheduled</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="NetTestCase"><a class="viewcode-back" href="../../writing_tests.html#ooni.nettest.NetTestCase">[docs]</a><span class="k">class</span> <span class="nc">NetTestCase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the base of the OONI nettest universe. When you write a nettest</span>
<span class="sd">    you will subclass this object.</span>

<span class="sd">    * inputs: can be set to a static set of inputs. All the tests (the methods</span>
<span class="sd">      starting with the &quot;test&quot; prefix) will be run once per input. At every</span>
<span class="sd">      run the _input_ attribute of the TestCase instance will be set to the</span>
<span class="sd">      value of the current iteration over inputs.  Any python iterable object</span>
<span class="sd">      can be set to inputs.</span>

<span class="sd">    * inputFile: attribute should be set to an array containing the command</span>
<span class="sd">      line argument that should be used as the input file. Such array looks</span>
<span class="sd">      like this:</span>

<span class="sd">          ``[&quot;commandlinearg&quot;, &quot;c&quot;, &quot;default value&quot; &quot;The description&quot;]``</span>

<span class="sd">      The second value of such arrray is the shorthand for the command line</span>
<span class="sd">      arg. The user will then be able to specify inputs to the test via:</span>

<span class="sd">          ``ooniprobe mytest.py --commandlinearg path/to/file.txt``</span>

<span class="sd">      or</span>

<span class="sd">          ``ooniprobe mytest.py -c path/to/file.txt``</span>


<span class="sd">    * inputProcessor: should be set to a function that takes as argument a</span>
<span class="sd">      filename and it will return the input to be passed to the test</span>
<span class="sd">      instance.</span>

<span class="sd">    * name: should be set to the name of the test.</span>

<span class="sd">    * author: should contain the name and contact details for the test author.</span>
<span class="sd">      The format for such string is as follows:</span>

<span class="sd">          ``The Name &lt;email@example.com&gt;``</span>

<span class="sd">    * version: is the version string of the test.</span>

<span class="sd">    * requiresRoot: set to True if the test must be run as root.</span>

<span class="sd">    * usageOptions: a subclass of twisted.python.usage.Options for processing</span>
<span class="sd">        of command line arguments</span>

<span class="sd">    * localOptions: contains the parsed command line arguments.</span>

<span class="sd">    Quirks:</span>
<span class="sd">    Every class that is prefixed with test *must* return a</span>
<span class="sd">    twisted.internet.defer.Deferred.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;This test is nameless&quot;</span>
    <span class="n">author</span> <span class="o">=</span> <span class="s">&quot;Jane Doe &lt;foo@example.com&gt;&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;0.0.0&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;Sorry, this test has no description :(&quot;</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">inputFile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">inputFilename</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">report</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">usageOptions</span> <span class="o">=</span> <span class="n">usage</span><span class="o">.</span><span class="n">Options</span>

    <span class="n">optParameters</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">baseParameters</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">baseFlags</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">requiredTestHelpers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">requiredOptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">requiresRoot</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">requiresTor</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">localOptions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the internal setup method to be overwritten by templates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="NetTestCase.requirements"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestCase.requirements">[docs]</a>    <span class="k">def</span> <span class="nf">requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Place in here logic that will be executed before the test is to be run.</span>
<span class="sd">        If some condition is not met then you should raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NetTestCase.setUp"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Place here your logic to be executed when the test is being setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NetTestCase.postProcessor"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestCase.postProcessor">[docs]</a>    <span class="k">def</span> <span class="nf">postProcessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclass this to do post processing tasks that are to occur once all</span>
<span class="sd">        the test methods have been called once per input.</span>
<span class="sd">        postProcessing works exactly like test methods, in the sense that</span>
<span class="sd">        anything that gets written to the object self.report[] will be added to</span>
<span class="sd">        the final test report.</span>
<span class="sd">        You should also place in this method any logic that is required for</span>
<span class="sd">        generating the summary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">NoPostProcessor</span>
</div>
<div class="viewcode-block" id="NetTestCase.displaySummary"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestCase.displaySummary">[docs]</a>    <span class="k">def</span> <span class="nf">displaySummary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This gets called after the test has run to allow printing out of a</span>
<span class="sd">        summary of the test run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NetTestCase.inputProcessor"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestCase.inputProcessor">[docs]</a>    <span class="k">def</span> <span class="nf">inputProcessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        You may replace this with your own custom input processor. It takes as</span>
<span class="sd">        input a file name.</span>

<span class="sd">        An inputProcessor is an iterator that will yield one item from the file</span>
<span class="sd">        and takes as argument a filename.</span>

<span class="sd">        This can be useful when you have some input data that is in a certain</span>
<span class="sd">        format and you want to set the input attribute of the test to something</span>
<span class="sd">        that you will be able to properly process.</span>

<span class="sd">        For example you may wish to have an input processor that will allow you</span>
<span class="sd">        to ignore comments in files. This can be easily achieved like so::</span>

<span class="sd">            fp = open(filename)</span>
<span class="sd">            for x in fp.xreadlines():</span>
<span class="sd">                if x.startswith(&quot;#&quot;):</span>
<span class="sd">                    continue</span>
<span class="sd">                yield x.strip()</span>
<span class="sd">            fp.close()</span>

<span class="sd">        Other fun stuff is also possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Running default input processor&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c"># Skip empty lines</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c"># Skip comment lines</span>
                <span class="k">elif</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">l</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputFileSpecified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            True</span>
<span class="sd">                when inputFile is supported and is specified</span>
<span class="sd">            False</span>
<span class="sd">                when input is either not support or not specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">localOptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<div class="viewcode-block" id="NetTestCase.getInputProcessor"><a class="viewcode-back" href="../../api/ooni.html#ooni.nettest.NetTestCase.getInputProcessor">[docs]</a>    <span class="k">def</span> <span class="nf">getInputProcessor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method must be called after all options are validated by</span>
<span class="sd">        _checkValidOptions and _checkRequiredOptions, which ensure that</span>
<span class="sd">        if the inputFile is a required option it will be present.</span>

<span class="sd">        We check to see if it&#39;s possible to have an input file and if the user</span>
<span class="sd">        has specified such file.</span>


<span class="sd">        If the operations to be done here are network related or blocking, they</span>
<span class="sd">        should be wrapped in a deferred. That is the return value of this</span>
<span class="sd">        method should be a :class:`twisted.internet.defer.Deferred`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            a generator that will yield one item from the file based on the</span>
<span class="sd">            inputProcessor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFileSpecified</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputFilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localOptions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFilename</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">_checkValidOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">localOptions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usageOptions</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="ow">or</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">InvalidOption</span>

    <span class="k">def</span> <span class="nf">_checkRequiredOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">missing_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">required_option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requiredOptions</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Checking if </span><span class="si">%s</span><span class="s"> is present&quot;</span> <span class="o">%</span> <span class="n">required_option</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">required_option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">localOptions</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">localOptions</span><span class="p">[</span><span class="n">required_option</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">missing_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">required_option</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">MissingRequiredOption</span><span class="p">(</span><span class="n">missing_options</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> inputs=</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, The Tor Project.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>